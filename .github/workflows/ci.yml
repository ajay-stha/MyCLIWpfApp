name: UI Tests with WinAppDriver

on:
  pull_request:
    branches: [ main ]

jobs:
  ui-tests:
    runs-on: [self-hosted, windows]

    steps:
    - name: Check if .NET is already installed
      id: check_dotnet
      shell: powershell
      run: |
        $dotnet = Get-Command dotnet -ErrorAction SilentlyContinue
        if ($null -eq $dotnet) {
          Write-Host ".NET not found. Installing..."
          echo "::set-output name=missing::true"
        } else {
          Write-Host ".NET is already installed. Version: $(dotnet --version)"
          echo "::set-output name=missing::false"
        }

    - name: Setup .NET ${{ vars.DOTNET_VERSION }}
      if: steps.check_dotnet.outputs.missing == 'true'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ vars.DOTNET_VERSION }}

    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration ${{ vars.BUILD_CONFIGURATION }}

    - name: Start WinAppDriver
      run: Start-Process "C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe"

    - name: Test
      shell: powershell
      run: |
        $code_coverage = '${{ vars.ENABLE_CODE_COVERAGE }}'
        if ($code_coverage -eq 'true') {
          dotnet test --no-build --configuration ${{ vars.BUILD_CONFIGURATION }} --collect:"XPlat Code Coverage"
        } else {
          dotnet test --no-build --configuration ${{ vars.BUILD_CONFIGURATION }}
        }
